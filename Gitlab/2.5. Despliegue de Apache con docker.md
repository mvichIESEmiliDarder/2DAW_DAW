## 1. Configuración Inicial en GitLab y Clonación

### 1.1. Crear el Proyecto Vacío en GitLab

1. **Inicia sesión en GitLab**.
    
2. Ve a **New project** (Nuevo proyecto) y selecciona **Create blank project** (Crear proyecto vacío).
    
3. Asígnale un nombre, por ejemplo: `hola-apache-ci-cd`.
    
4. Haz clic en **Create project**.
    

### 1.2. Clonar el Proyecto en tu PC (VSC)

1. En la página de tu nuevo proyecto, copia la **URL SSH** (ej: `git@tu.servidor.ip:tu-usuario/hola-apache-ci-cd.git`).
    
2. Abre **VS Code** en tu PC.
    
3. Abre la paleta de comandos (Ctrl+Shift+P) y selecciona **Git: Clone**.
    
4. Pega la URL y selecciona la carpeta de destino.
    

---

## 2. Crear la Página Web y el Dockerfile

### 2.1. Crear la Página Web (`index.html`)

1. Crea un archivo llamado **`index.html`** en la raíz de tu proyecto local.
    
2. Añade el contenido:
    
    HTML
    
    ```
    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Hola Apache!</title>
    </head>
    <body>
        <h1>¡Hola Apache!</h1>
        <p>Esta página fue desplegada automáticamente con GitLab CI/CD y Docker. ✨</p>
    </body>
    </html>
    ```
    

### 2.2. Crear el Dockerfile

1. Crea un archivo llamado **`Dockerfile`** en la raíz.
    
2. Este define cómo se construirá tu imagen de Apache:
    
    Dockerfile
    
    ```
    # Usar una imagen base ligera de Apache
    FROM httpd:2.4-alpine
    
    # Copiar tu archivo index.html al directorio de documentos de Apache
    COPY index.html /usr/local/apache2/htdocs/
    
    # Exponer el puerto 80 (aunque la imagen base ya lo hace)
    EXPOSE 80
    ```
    

---

## 3. Configurar el Despliegue CI/CD con el Runner

Para que GitLab pueda construir la imagen, empujarla a un registro y luego usar el Runner para ejecutarla en el servidor de destino, necesitamos dos cosas: el archivo `.gitlab-ci.yml` y las variables de entorno.

### 3.1. Almacenar Variables de Entorno Seguras

Para que el Runner pueda conectarse con el demonio de Docker y ejecutar comandos, es mejor usar la configuración del _shell_ del Runner y no el _executor_ de Docker-in-Docker (dind), ya que el Runner está en la máquina de destino.

**Opción recomendada: Configuración SSH para despliegue (asumiendo que el Runner está configurado con el _Shell Executor_ o tiene acceso SSH a sí mismo si fuera necesario):**

1. **Genera un par de claves SSH** (si no lo tienes) que el Runner usará para conectarse de forma segura.
   ```bash
   ssh-keygen -t rsa -b 4096 -C "gitlab-deploy-key"
   ```
    
2. **Añade la clave pública** del par SSH al archivo `~/.ssh/authorized_keys` del usuario que ejecuta Docker en `192.168.201.2`.
   ```bash
   ssh-copy-id -i ~/.ssh/id_rsa.pub iesemili@192.168.201.2
   ```
    
3. En tu proyecto de GitLab, ve a **Settings > CI/CD > Variables**.
    
4. Añade las siguientes variables de tipo **Variable**:
    
    - `SERVER_HOST`: `192.168.201.2` (Máscara la variable)
        
    - `SERVER_USER`: `usuario_ssh_del_servidor` (Máscara la variable)
        
5. Añade la siguiente variable de tipo **File**:
    
    - `SSH_PRIVATE_KEY`: **Pega el contenido COMPLETO de la clave privada SSH** que generaste (Asegúrate de hacerlo tipo file, visible y  marcar **Protect variable**).
        

### 3.2. Crear el Archivo `.gitlab-ci.yml`

1. Crea un archivo llamado **`.gitlab-ci.yml`** en la raíz del proyecto.
    
2. Este script definirá un _pipeline_ de dos etapas: **construir** la imagen y **desplegarla** en el servidor. Usaremos el **Container Registry** interno de GitLab (asumiendo que lo tienes habilitado y que el Runner puede acceder a él).
    
    YAML
    ```yaml
# ⚠️ IMPORTANTE: El Runner Shell no necesita una imagen base,
# sino que asume que las herramientas (docker, ssh) están instaladas en el host 192.168.201.2.
 
variables:
  # Nombre de la imagen en el Container Registry de GitLab
  DOCKER_IMAGE: $CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_SHORT_SHA
  # Nombre del contenedor en el servidor de destino
  CONTAINER_NAME: hola-apache-app
 
stages:
  - build
  - deploy
 
# --- ETAPA DE CONSTRUCCIÓN Y PUSH (Ejecutado por el Runner Shell) ---
build_image:
  stage: build
  script:
    # 1. Login en el Container Registry de GitLab (Usa el docker del host)
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    # 2. Construir la imagen
    - docker build -t $DOCKER_IMAGE .
    # 3. Empujar la imagen al registro
    - docker push $DOCKER_IMAGE
  tags:
    - 'shell' # Asegúrate de que esta etiqueta coincida con la de tu Runner
 
# --- ETAPA DE DESPLIEGUE (Ejecutado por el Runner Shell vía SSH a sí mismo) ---
deploy_container:
  stage: deploy
  script:
    # 1. Configuración de la Clave Privada (la variable $SSH_PRIVATE_KEY es el path del archivo)
    - chmod 600 $SSH_PRIVATE_KEY
    - eval $(ssh-agent -s)
    - ssh-add $SSH_PRIVATE_KEY
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # Evitar preguntas de 'Are you sure you want to continue connecting?'
    - ssh-keyscan $SERVER_HOST >> ~/.ssh/known_hosts 

    # 2. Comandos de Despliegue ejecutados remotamente (vía SSH al mismo host 192.168.201.2)
    - | # Bloque de comandos remotos
      ssh $SERVER_USER@$SERVER_HOST "
        # A. Login remoto para pull de imagen privada
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        # B. Pull de la nueva imagen
        docker pull $DOCKER_IMAGE
        # C. Detener y eliminar contenedor antiguo
        docker stop $CONTAINER_NAME || true
        docker rm $CONTAINER_NAME || true
        # D. Iniciar nuevo contenedor
        docker run -d --name $CONTAINER_NAME -p 80:80 $DOCKER_IMAGE
      "
  only:
    - main # Desplegar solo al branch principal
  tags:
    - 'shell' # El mismo tag de tu Runner
  
    ```
    

---

## 4. Subir Cambios y Ejecutar el Pipeline

1. En VS Code, añade y sube todos los archivos (`index.html`, `Dockerfile`, `.gitlab-ci.yml`):
    
    Bash
    
    ```
    git add .
    git commit -m "Configuracion inicial de web y CI/CD"
    git push origin main
    ```
    
2. **Verificación del Despliegue:**
    
    - Una vez que hagas el `git push`, ve a tu proyecto en GitLab y navega a **CI/CD > Pipelines**.
        
    - Deberías ver un _pipeline_ ejecutándose con las etapas `build` y `deploy`.
        
    - Si el Runner está correctamente registrado y etiquetado, la etapa `deploy` debería ejecutarse con éxito.
        
3. **Verificación Final:**
    
    - Abre tu navegador y navega a la dirección: `http://192.168.201.2/`
        
    - Deberías ver tu página **"¡Hola Apache!"**.