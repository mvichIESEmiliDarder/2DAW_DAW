
# 📝 Guía: Instalación y Configuración del GitLab Runner en Servidor Apache

Esta guía resume el proceso para instalar y registrar un GitLab Runner con el _executor_ `shell` en el mismo servidor donde se aloja Apache, permitiendo el despliegue directo del código.

## 1. Instalación del Software del Runner (en el Servidor Apache)

Se instaló el binario de GitLab Runner en el servidor `192.168.204.17` (Ubuntu/Debian) para que pueda funcionar como un servicio del sistema.

1. **Añadir el Repositorio de GitLab:**
    
    Bash
    
    ```
    curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | sudo bash
    ```
    
2. **Instalar el Runner:**
    
    Bash
    
    ```
    sudo apt-get update && sudo apt-get install gitlab-runner
    ```
    

---

## 2. Obtención del Token de Registro (en la Interfaz de GitLab)

Para vincular el _software_ instalado con tu proyecto específico, necesitas el token de registro:

1. Navega a la interfaz web de tu proyecto en GitLab.
    
2. Ve a **Settings**, **CI/CD**.
    
3. Expande la sección **Runners** y haz clic en **New project runner**.
    
4. Define un **Tag** para el Runner (ej: `apache-prod`).
    
5. Completa el proceso y **copia la URL de GitLab** (ej: `http://gitlab.local`) y el **Token de Registro** que te proporciona la guía.
    

---

## 3. Registro del Runner (en el Servidor Apache)

El Runner se registró en modo **sistema** (`sudo`) y se configuró para usar el **`shell` executor**, que es fundamental para el despliegue local.

1. **Ejecutar el comando de registro (con `sudo`):**
    
    Bash
    
    ```
    sudo gitlab-runner register \
      --url <TU_URL_DE_GITLAB> \
      --token <TU_TOKEN_DE_REGISTRO>
    ```
    
2. **Responder a los _Prompts_ (Preguntas Clave):**
    
    - **Enter the GitLab instance URL:** Se ingresó la URL **completa con el protocolo**, asegurando que fuera `http://gitlab.local`.
        
    - **Enter a name for the runner:** Se definió un nombre descriptivo (ej: `ApacheServer`).
        
    - **Enter an executor:** Se eligió **`shell`**, ya que permite al Runner ejecutar comandos de copia y permisos directamente en el servidor Apache.
        
    - **Enter tags for the runner:** Se confirmó el tag **`apache-prod`** para que este Runner solo ejecute _jobs_ etiquetados de esa forma.
        

---

## 4. Configuración de Permisos (en el Servidor Apache)

Para que el Runner pueda escribir archivos en el directorio de Apache, se ajustaron los permisos del usuario de servicio del Runner (`gitlab-runner`):

1. **Añadir el usuario del Runner al grupo de Apache:**
    
    ```bash
    sudo usermod -aG www-data gitlab-runner
    ```
    
1. **Establecer los permisos necesarios en la carpeta destino:**
       
    ```bash
    sudo chown -R root:www-data /var/www/html
    sudo chmod -R 775 /var/www/html
    sudo chmod g+s /var/www/html
    ```

3. **Reiniciar el servicio del Runner** para aplicar los nuevos permisos:

    
    ```bash
    sudo systemctl restart gitlab-runner
    ```
    

---

## 5. Creación del Pipeline de Despliegue (`.gitlab-ci.yml`)

Finalmente, se creó el archivo de configuración en la raíz del proyecto para definir el _job_ de despliegue que usa el Runner.

**Estructura Clave:**

```yml
deploy_to_apache:
stage: deploy
tags:
- apache-prod # ¡Esto vincula el job a tu Runner!
script:
- echo "Iniciando despliegue en el servidor..."
- APACHE_PATH="/var/www/html/HolaApache"
# Crea la carpeta (si es necesario)
- mkdir -p $APACHE_PATH
# Sincroniza el contenido del proyecto con la carpeta de Apache
- rsync -av --exclude '.git' $CI_PROJECT_DIR/ $APACHE_PATH
- echo "Despliegue completado."
```

---

## 6. Verificación Final

Se verificó el correcto funcionamiento en dos puntos:

- **Localmente:** Confirmando que el servicio está activo: `sudo systemctl status gitlab-runner` o con la instrucción `gitlab-runner --version`
    
- **Remotamente:** Verificando que el Runner aparezca con un **círculo verde** en `Settings`, `CI/CD`, `Runners` de GitLab.
 ![[Pasted image 20251007131902.png]]   
Con estos pasos, cualquier _push_ o activación manual del _pipeline_ despliega automáticamente el código en tu servidor Apache.