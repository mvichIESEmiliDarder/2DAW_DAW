
#  Gu铆a: Instalaci贸n y Configuraci贸n del GitLab Runner en Servidor Apache

Esta gu铆a resume el proceso para instalar y registrar un GitLab Runner con el _executor_ `shell` en el mismo servidor donde se aloja Apache, permitiendo el despliegue directo del c贸digo.

## 1. Instalaci贸n del Software del Runner (en el Servidor Apache)

Se instal贸 el binario de GitLab Runner en el servidor `192.168.204.17` (Ubuntu/Debian) para que pueda funcionar como un servicio del sistema.

1. **A帽adir el Repositorio de GitLab:**
    
    Bash
    
    ```
    curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | sudo bash
    ```
    
2. **Instalar el Runner:**
    
    Bash
    
    ```
    sudo apt-get update && sudo apt-get install gitlab-runner
    ```
    

---

## 2. Obtenci贸n del Token de Registro (en la Interfaz de GitLab)

Para vincular el _software_ instalado con tu proyecto espec铆fico, necesitas el token de registro:

1. Navega a la interfaz web de tu proyecto en GitLab.
    
2. Ve a **Settings**, **CI/CD**.
    
3. Expande la secci贸n **Runners** y haz clic en **New project runner**.
    
4. Define un **Tag** para el Runner (ej: `apache-prod`).
    
5. Completa el proceso y **copia la URL de GitLab** (ej: `http://gitlab.local`) y el **Token de Registro** que te proporciona la gu铆a.
    

---

## 3. Registro del Runner (en el Servidor Apache)

El Runner se registr贸 en modo **sistema** (`sudo`) y se configur贸 para usar el **`shell` executor**, que es fundamental para el despliegue local.

1. **Ejecutar el comando de registro (con `sudo`):**
    
    Bash
    
    ```
    sudo gitlab-runner register \
      --url <TU_URL_DE_GITLAB> \
      --token <TU_TOKEN_DE_REGISTRO>
    ```
    
2. **Responder a los _Prompts_ (Preguntas Clave):**
    
    - **Enter the GitLab instance URL:** Se ingres贸 la URL **completa con el protocolo**, asegurando que fuera `http://gitlab.local`.
        
    - **Enter a name for the runner:** Se defini贸 un nombre descriptivo (ej: `ApacheServer`).
        
    - **Enter an executor:** Se eligi贸 **`shell`**, ya que permite al Runner ejecutar comandos de copia y permisos directamente en el servidor Apache.
        
    - **Enter tags for the runner:** Se confirm贸 el tag **`apache-prod`** para que este Runner solo ejecute _jobs_ etiquetados de esa forma.
        

---

## 4. Configuraci贸n de Permisos (en el Servidor Apache)

Para que el Runner pueda escribir archivos en el directorio de Apache, se ajustaron los permisos del usuario de servicio del Runner (`gitlab-runner`):

1. **A帽adir el usuario del Runner al grupo de Apache:**
    
    ```bash
    sudo usermod -aG www-data gitlab-runner
    ```
    
1. **Establecer los permisos necesarios en la carpeta destino:**
       
    ```bash
    sudo chown -R root:www-data /var/www/html
    sudo chmod -R 775 /var/www/html
    sudo chmod g+s /var/www/html
    ```

3. **Reiniciar el servicio del Runner** para aplicar los nuevos permisos:

    
    ```bash
    sudo systemctl restart gitlab-runner
    ```
    

---

## 5. Creaci贸n del Pipeline de Despliegue (`.gitlab-ci.yml`)

Finalmente, se cre贸 el archivo de configuraci贸n en la ra铆z del proyecto para definir el _job_ de despliegue que usa el Runner.

**Estructura Clave:**

```yml
deploy_to_apache:
stage: deploy
tags:
- apache-prod # 隆Esto vincula el job a tu Runner!
script:
- echo "Iniciando despliegue en el servidor..."
- APACHE_PATH="/var/www/html/HolaApache"
# Crea la carpeta (si es necesario)
- mkdir -p $APACHE_PATH
# Sincroniza el contenido del proyecto con la carpeta de Apache
- rsync -av --exclude '.git' $CI_PROJECT_DIR/ $APACHE_PATH
- echo "Despliegue completado."
```

---

## 6. Verificaci贸n Final

Se verific贸 el correcto funcionamiento en dos puntos:

- **Localmente:** Confirmando que el servicio est谩 activo: `sudo systemctl status gitlab-runner` o con la instrucci贸n `gitlab-runner --version`
    
- **Remotamente:** Verificando que el Runner aparezca con un **c铆rculo verde** en `Settings`, `CI/CD`, `Runners` de GitLab.
 ![[Pasted image 20251007131902.png]]   
Con estos pasos, cualquier _push_ o activaci贸n manual del _pipeline_ despliega autom谩ticamente el c贸digo en tu servidor Apache.